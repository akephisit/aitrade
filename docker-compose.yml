# ── Antigravity Trading System — Docker Compose ───────────────────────────────
# รัน: docker compose up -d
# หยุด: docker compose down

services:

  # ── PostgreSQL ──────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: antigravity-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: antigravity
      POSTGRES_USER: agv
      POSTGRES_PASSWORD: changeme_in_production
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U agv -d antigravity" ]
      interval: 5s
      timeout: 3s
      retries: 10

  # ── Backend (Axum) ───────────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: antigravity-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      BIND_ADDR: 0.0.0.0:3000
      MT5_BASE_URL: ${MT5_BASE_URL:-http://host.docker.internal:8081}
      RUST_LOG: antigravity=info,tower_http=warn

      # Confirmation Engine
      CONFIRM_MAX_SPREAD: ${CONFIRM_MAX_SPREAD:-50.0}
      CONFIRM_REQUIRE_PROBE: ${CONFIRM_REQUIRE_PROBE:-true}
      CONFIRM_MIN_ZONE_TICKS: ${CONFIRM_MIN_ZONE_TICKS:-2}
      CONFIRM_PROBE_LOOKBACK: ${CONFIRM_PROBE_LOOKBACK:-15}
      CONFIRM_RSI_OVERBOUGHT: ${CONFIRM_RSI_OVERBOUGHT:-70.0}
      CONFIRM_RSI_OVERSOLD: ${CONFIRM_RSI_OVERSOLD:-30.0}

      # Risk Management
      RISK_MAX_TRADES_PER_DAY: ${RISK_MAX_TRADES_PER_DAY:-10}
      RISK_MAX_CONSECUTIVE_FAILS: ${RISK_MAX_CONSECUTIVE_FAILS:-3}
      RISK_COOLDOWN_SECS: ${RISK_COOLDOWN_SECS:-300}
      # PostgreSQL (ถ้าต้องการ: เพิ่ม --features postgres ใน Dockerfile)
      # DATABASE_URL: postgres://agv:changeme_in_production@postgres:5432/antigravity
    extra_hosts:
      - "host.docker.internal:host-gateway" # เข้าถึง MT5 บน host

  # ── OpenClaw (AI Agent) ──────────────────────────────────────────────────────
  openclaw:
    build:
      context: ./openclaw
      dockerfile: Dockerfile
    container_name: antigravity-openclaw
    restart: unless-stopped
    depends_on:
      - backend
    environment:
      AITRADE_URL: http://backend:3000
      AI_PROVIDER: ${AI_PROVIDER:-claude}
      AI_API_KEY: ${AI_API_KEY:?AI_API_KEY is required}
      SYMBOL: ${SYMBOL:-BTCUSD}
      BRAIN_INTERVAL_SECS: ${BRAIN_INTERVAL_SECS:-300}
      STRATEGY_TTL_MIN: ${STRATEGY_TTL_MIN:-15}
      MARKET_URL: ${MARKET_URL:-}
      RUST_LOG: openclaw=info

  # ── Frontend (SvelteKit Dashboard) ──────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: antigravity-frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "3001:3001"
    environment:
      PORT: 3001
      PUBLIC_WS_URL: ws://localhost:3000
      PUBLIC_API_URL: http://localhost:3000

volumes:
  pgdata:
    driver: local
