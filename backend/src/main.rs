//! # Antigravity â€” High-Performance Automated Trading Backend
//!
//! ```text
//!  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  POST /api/brain/strategy   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
//!  â”‚  OpenClaw    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  AppState                â”‚
//!  â”‚  (AI Agent)  â”‚                              â”‚  RwLock<ActiveStrategy>  â”‚
//!  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  RwLock<OpenPosition>    â”‚
//!                                                â”‚  RwLock<TradeHistory>    â”‚
//!  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  POST /api/mt5/tick          â”‚  broadcast_tx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
//!  â”‚  MetaTrader  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  [Reflex Engine]         â”‚â”‚
//!  â”‚  5 (EA)      â”‚  â† POST /order/send (MT5)    â”‚  [Executor]              â”‚â”‚
//!  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
//!                                                         â”‚                  â”‚
//!  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  ws://..../ws/monitor  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//!  â”‚  SvelteKit   â”‚  GET /api/monitor/position
//!  â”‚  Dashboard   â”‚  GET /api/monitor/history
//!  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  GET /api/monitor/stats
//! ```

use std::net::SocketAddr;

use axum::{
    Router,
    routing::{delete, get, post},
};
use tower_http::{
    cors::{Any, CorsLayer},
    trace::TraceLayer,
};
use tracing::info;
use tracing_subscriber::{fmt, prelude::*, EnvFilter};

mod engine;
mod error;
mod events;
mod models;
mod routes;
mod state;

use routes::{
    brain::{clear_strategy, get_strategy, set_strategy},
    monitor::{get_history, get_position, get_stats, ws_monitor},
    mt5::{handle_tick, health_check},
};
use state::build_state;

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    // â”€â”€ 1. Load .env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    dotenvy::dotenv().ok();

    // â”€â”€ 2. Structured logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    tracing_subscriber::registry()
        .with(fmt::layer())
        .with(
            EnvFilter::from_default_env()
                .add_directive("antigravity=debug".parse()?)
                .add_directive("tower_http=info".parse()?),
        )
        .init();

    info!(
        r#"

  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘          ANTIGRAVITY â€” Trading Backend            â•‘
  â•‘   Brain & Reflex Â· Position Mgmt Â· WS Monitor    â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"#
    );

    // â”€â”€ 3. Shared state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let state = build_state();

    // â”€â”€ 4. CORS (à¹ƒà¸«à¹‰ SvelteKit dev server à¸•à¹ˆà¸­à¹„à¸”à¹‰) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let cors = CorsLayer::new()
        .allow_origin(Any)   // à¸›à¸£à¸±à¸šà¹ƒà¸«à¹‰ strict à¹ƒà¸™ production
        .allow_methods(Any)
        .allow_headers(Any);

    // â”€â”€ 5. Router â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let app = Router::new()
        // â”€â”€ Reflex Loop (MT5 â†’ Axum) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        .route("/api/mt5/tick",           post(handle_tick))
        .route("/api/mt5/health",         get(health_check))
        // â”€â”€ Brain Loop (OpenClaw â†’ Axum) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        .route("/api/brain/strategy",     post(set_strategy))
        .route("/api/brain/strategy",     get(get_strategy))
        .route("/api/brain/strategy",     delete(clear_strategy))
        // â”€â”€ Monitor Loop (SvelteKit â†’ Axum) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        .route("/ws/monitor",             get(ws_monitor))       // WebSocket
        .route("/api/monitor/position",   get(get_position))     // REST
        .route("/api/monitor/history",    get(get_history))
        .route("/api/monitor/stats",      get(get_stats))
        // â”€â”€ Middleware â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        .layer(TraceLayer::new_for_http())
        .layer(cors)
        .with_state(state);

    // â”€â”€ 6. Bind & Serve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let addr: SocketAddr = std::env::var("BIND_ADDR")
        .unwrap_or_else(|_| "0.0.0.0:3000".to_string())
        .parse()?;

    info!(?addr, "ğŸš€ Antigravity server starting");

    let listener = tokio::net::TcpListener::bind(addr).await?;
    axum::serve(listener, app).await?;

    Ok(())
}
